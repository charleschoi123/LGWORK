<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LGWORK • 企业入口（JD 生成 / 解析 / 匹配候选人）</title>
<style>
  :root{--pri:#0a66c2;--bg:#f3f2ef;--fg:#091e42;--muted:#5e6c84;--card:#fff;--border:#e0e0e0;--good:#17a34a}
  body{font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0}
  .wrap{max-width:1080px;margin:0 auto;padding:24px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
  .btn{background:var(--pri);color:#fff;border:0;border-radius:10px;padding:10px 16px;cursor:pointer}
  input,textarea{width:100%;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;font-family:inherit}
  .progress{height:6px;background:#e9eef5;border-radius:999px;overflow:hidden;margin:10px 0}
  .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--pri),#2b8be6);transition:width .45s ease}
  .pulse>i{animation:pulse 1.1s ease-in-out infinite}
  @keyframes pulse{0%{opacity:.45}50%{opacity:1}100%{opacity:.45}}
  .mono{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace}
  .muted{color:var(--muted)}
  .cand{border:1px solid var(--border);border-radius:12px;padding:12px;margin:8px 0;background:#fff}
  .score{color:var(--good);font-weight:600}
</style>
</head>
<body>
<div class="wrap">
  <h2>企业入口</h2>
  <div class="grid">
    <div class="card">
      <h3>我先说需求，由 AI 生成 JD</h3>
      <textarea id="need" rows="10" placeholder="例如：上海招临床项目经理，I-III期，肿瘤方向，5年以上…"></textarea>
      <div class="progress" id="progG"><i></i></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="btnGen">生成 JD</button>
        <span class="muted" id="gstatus">就绪</span>
      </div>
      <div id="genout" class="mono" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>上传/粘贴 JD（可选）</h3>
      <input type="file" id="jdfile" accept=".pdf,.doc,.docx,.txt" />
      <div style="margin:8px 0">或：</div>
      <textarea id="jdtext" rows="10" placeholder="在此粘贴 JD 原文…"></textarea>
      <div class="progress" id="progP"><i></i></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="btnParse">解析 JD 要点</button>
        <button class="btn" id="btnMatch">匹配候选人</button>
        <span class="muted" id="pstatus">就绪</span>
      </div>
      <div id="jdout" class="mono" style="margin-top:8px"></div>
      <div id="matchout" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s)
function setProg(el,v){ el.querySelector('i').style.width=Math.max(0,Math.min(100,v))+'%' }
function pulse(el,on){ el.classList.toggle('pulse',!!on) }
function tw(el,text){ el.textContent=''; let i=0; (function t(){ el.textContent+=text.slice(i,i+2); i+=2; if(i<text.length) requestAnimationFrame(t) })() }
function esc(s){return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;')}

$('#btnGen').onclick=async()=>{
  pulse($('#progG'),true); setProg($('#progG'),20); $('#gstatus').textContent='生成中…'
  const r=await fetch('/api/jd/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({need:$('#need').value,lang:'zh'})})
  const d=await r.json(); setProg($('#progG'),85)
  tw($('#genout'), d.jd||'')
  setTimeout(()=>{setProg($('#progG'),100); pulse($('#progG'),false); $('#gstatus').textContent='完成'},260)
}

$('#btnParse').onclick=async()=>{
  pulse($('#progP'),true); setProg($('#progP'),15); $('#pstatus').textContent='解析中…'
  let jdText=$('#jdtext').value
  const f=$('#jdfile').files[0]; if(!jdText && f){
    const fd=new FormData(); fd.append('file', f)
    const r0=await fetch('/api/jd/parse',{method:'POST',body: fd}); const d0=await r0.json(); jdText=d0.jd_summary||''
  }
  if(!jdText){ $('#jdout').textContent='请上传或粘贴 JD'; setProg($('#progP'),100); pulse($('#progP'),false); $('#pstatus').textContent='就绪'; return }
  const fd2=new FormData(); fd2.append('text', jdText)
  const r=await fetch('/api/jd/parse',{method:'POST',body: fd2}); const d=await r.json(); setProg($('#progP'),85)
  tw($('#jdout'), d.jd_summary||'')
  setTimeout(()=>{setProg($('#progP'),100); pulse($('#progP'),false); $('#pstatus').textContent='完成'},240)
}

$('#btnMatch').onclick=async()=>{
  pulse($('#progP'),true); setProg($('#progP'),25); $('#pstatus').textContent='匹配中…'
  let jdText = ($('#jdout').textContent||'').trim() || $('#jdtext').value
  if(!jdText){ const g=$('#genout').textContent.trim(); if(g) jdText=g }
  if(!jdText){ alert('请先生成或提供 JD'); setProg($('#progP'),0); pulse($('#progP'),false); $('#pstatus').textContent='就绪'; return }
  const r = await fetch('/api/candidates/match',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({ jd_text: jdText, k: 8 })})
  const d = await r.json(); setProg($('#progP'),85)
  const arr = d.items || []
  if(!arr.length){ $('#matchout').innerHTML = '<div class="muted">暂未匹配到候选人（待有更多求职者画像入库）。</div>' }
  else{
    $('#matchout').innerHTML = arr.map(x=>`<div class='cand'>
      <div><b>${esc(x.name||'（匿名）')}</b> <span class='muted'>${esc(x.email||'')}</span> <span class='score'>${x.match?.score||''}/100</span></div>
      <div class='mono' style='margin-top:6px'>优势：\n- ${(x.match?.analysis?.top_matches||[]).join('\n- ')}</div>
      ${(x.match?.analysis?.gaps||[]).length?`<div class='mono' style='margin-top:6px'>差距：\n- ${(x.match.analysis.gaps||[]).join('\n- ')}</div>`:''}
    </div>`).join('')
  }
  setTimeout(()=>{ setProg($('#progP'), 100); pulse($('#progP'), false); $('#pstatus').textContent='完成' }, 240)
}
</script>
</body>
</html>
