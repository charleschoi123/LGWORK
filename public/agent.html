<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>LGWORK · AI 求职副驾</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0f14;--panel:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--brand:#38bdf8}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Microsoft YaHei",sans-serif}
    header{position:sticky;top:0;background:rgba(11,15,20,.85);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937;z-index:10}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0 0 6px;font-size:20px;display:flex;gap:10px;align-items:center}.dot{width:10px;height:10px;border-radius:999px;background:var(--brand);box-shadow:0 0 14px var(--brand)}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:14px}@media(max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
    textarea{width:100%;min-height:180px;padding:10px;border-radius:12px;border:1px solid #29303a;background:var(--panel);color:var(--text);resize:vertical}
    input,select,button{padding:10px 12px;border-radius:12px;border:1px solid #29303a;background:var(--panel);color:var(--text)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{cursor:pointer}.primary{background:#0369a1;border-color:#0369a1}
    .muted{color:var(--muted);font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:#1f2937;border:1px solid #2a3441}
    .toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .grid-jobs{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media(max-width:1100px){.grid-jobs{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:740px){.grid-jobs{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:700}.meta{font-size:13px;color:var(--muted);display:flex;flex-wrap:wrap;gap:6px}
    .ops{display:flex;gap:8px;flex-wrap:wrap}
    .toast{position:fixed;bottom:14px;right:14px;background:#0f172a;border:1px solid #29303a;border-radius:12px;padding:10px 12px;display:none}
    .select{padding:8px 10px;border-radius:10px;background:#0f172a;color:var(--text);border:1px solid #29303a}
    .empty{border:1px dashed #334155;border-radius:16px;padding:36px 12px;text-align:center;color:var(--muted)}
    .inline{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1><span class="dot"></span>LGWORK · AI 求职副驾</h1>
    <div class="muted">上传/粘贴简历 → 一键分析并推荐（画像+匹配排序） → 单个职位做精评与面试包。</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- 左：简历与筛选 -->
    <div class="panel">
      <div>简历文本</div>
      <textarea id="cv" placeholder="粘贴你的简历（或核心经历要点）"></textarea>
      <div class="row" style="margin-top:8px">
        <input id="file" type="file" accept=".pdf,.docx,.txt" />
        <button id="btnUpload" class="btn">上传并解析</button>
        <button id="btnAR" class="btn primary">分析并推荐</button>
      </div>

      <div id="profileBox" style="display:none;margin-top:10px">
        <div class="inline">
          <div class="muted">画像关键词：</div>
          <label class="inline" style="gap:6px">
            <input type="checkbox" id="consult" />
            <span class="muted">我有兴趣做兼职顾问/远程</span>
          </label>
        </div>
        <div id="kwChips" class="chips"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="loc" style="flex:1" placeholder="地点（可多项：上海/苏州/远程）" />
        <select id="type" class="select">
          <option value="">类型</option><option value="full">全职</option><option value="part">兼职</option><option value="project">项目制</option>
        </select>
        <select id="mode" class="select">
          <option value="">办公</option><option value="onsite">Onsite</option><option value="hybrid">Hybrid</option><option value="remote">Remote</option>
        </select>
      </div>
      <div class="muted" style="margin-top:8px">提示：如服务繁忙，画像会自动降级为关键词抽取，但推荐仍可正常演示。</div>
    </div>

    <!-- 右：职位列表 -->
    <div class="panel">
      <div class="toolbar">
        <div class="muted">共 <span id="count">0</span> 条推荐（按匹配度排序）</div>
        <select id="limit" class="select">
          <option value="20">显示 20</option><option value="50">显示 50</option><option value="100">显示 100</option>
        </select>
      </div>
      <div id="list" class="grid-jobs"></div>
      <div id="empty" class="empty" style="display:none">没有结果，试试放宽筛选或补充关键词</div>
    </div>
  </div>
</main>

<div id="toast" class="toast"></div>

<script>
  const API_BASE = '';
  function api(url, opts={}){ const base = API_BASE?API_BASE:''; return fetch(base+url, opts); }
  function toast(msg, err=false){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; t.style.borderColor=err?'#7f1d1d':'#29303a'; setTimeout(()=>t.style.display='none',1800); }
  const esc = s => (s||'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  const chip = s => `<span class="chip">${esc(s)}</span>`;

  const els = {
    cv: document.getElementById('cv'),
    file: document.getElementById('file'),
    btnUpload: document.getElementById('btnUpload'),
    btnAR: document.getElementById('btnAR'),
    profileBox: document.getElementById('profileBox'),
    kwChips: document.getElementById('kwChips'),
    consult: document.getElementById('consult'),
    loc: document.getElementById('loc'),
    type: document.getElementById('type'),
    mode: document.getElementById('mode'),
    list: document.getElementById('list'),
    empty: document.getElementById('empty'),
    limit: document.getElementById('limit'),
    count: document.getElementById('count')
  };

  // 恢复简历
  (function restoreCV(){
    try{ const cached = localStorage.getItem('LGWORK_RESUME'); if(cached && !els.cv.value.trim()) els.cv.value = cached; }catch{}
  })();

  // 上传并解析
  els.btnUpload.onclick = async ()=>{
    const f = els.file.files[0];
    if(!f){ toast('请选择 PDF/DOCX/TXT 文件', true); return; }
    const form = new FormData(); form.append('file', f);
    toast('正在解析简历…');
    try{
      const r = await api('/api/upload_resume', { method:'POST', body: form });
      const d = await r.json();
      if(!r.ok || d.error) throw new Error('解析失败');
      els.cv.value = d.text || '';
      toast('解析成功');
    }catch(e){ toast('解析失败，请重试', true); }
  };

  // 一键：分析并推荐
  els.btnAR.onclick = analyzeAndRecommend;
  els.limit.onchange = ()=> progressiveRender(window.__lastItems__||[]);

  async function analyzeAndRecommend(){
    const text = els.cv.value.trim();
    if(!text){ toast('请先上传/粘贴简历文本', true); return; }

    const filters = {
      location: els.loc.value.trim(),
      type: els.type.value,
      work_mode: els.mode.value
    };

    toast('正在分析并生成推荐…');
    try{
      const r = await api('/api/analyze_recommend', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ resume_text: text, filters, top_n: 100 })
      });
      const d = await r.json();
      if(!r.ok || d.error){ throw new Error('分析服务暂不可用'); }

      // 画像（可能是 LLM，也可能是降级兜底）
      const kws = ((d.profile||{}).keywords || []);
      els.profileBox.style.display = 'block';
      els.kwChips.innerHTML = (kws.length? kws : []).map(chip).join('');

      // 列表
      const items = d.items || [];
      window.__lastItems__ = items;
      progressiveRender(items);
      els.count.textContent = d.total || items.length || 0;

      // 缓存简历（给面试包用）
      try{ localStorage.setItem('LGWORK_RESUME', text); }catch{}

      toast('已完成');
    }catch(e){
      console.error(e);
      toast('分析服务繁忙，请稍后再试', true);
    }
  }

  function progressiveRender(items){
    const topN = parseInt(els.limit.value || '20',10);
    const arr = items.slice(0, topN);
    els.list.innerHTML = ''; els.empty.style.display = arr.length? 'none':'block';
    if(!arr.length) return;
    let i=0, step=8;
    const timer = setInterval(()=>{
      els.list.insertAdjacentHTML('beforeend', arr.slice(i,i+step).map(renderCard).join(''));
      i += step; if(i>=arr.length) clearInterval(timer);
    }, 50);
  }

  function renderCard(it){
    const tags = (it.tags || []).map(chip).join(' ');
    const salary = fmtSalary(it.salary_min, it.salary_max, it.currency);
    return `
      <div class="card">
        <div class="title">${esc(it.title)}</div>
        <div class="meta">
          <span>${esc(it.company)}</span><span>·</span><span>${esc(it.location||'')}</span><span>·</span>
          <span>${esc((it.work_mode||'').toUpperCase())}</span><span>·</span><span>${esc((it.type||'').toUpperCase())}</span>
          ${it.posted_at ? `<span>·</span><span>${esc(it.posted_at)}</span>` : ``}
        </div>
        <div class="chips">${tags}</div>
        <div>匹配度：${it._score ?? 0} · 薪资：${salary}</div>
        ${it.jd_url ? `<div>原链：<a href="${esc(it.jd_url)}" target="_blank" rel="noopener">${esc(it.jd_url)}</a></div>` : ``}
        <div class="ops">
          <button class="btn" onclick="llmMatch('${encodeURIComponent(it.id)}')">LLM 精评</button>
          <button class="btn" onclick="openInterview('${encodeURIComponent(it.id)}')">面试准备包</button>
        </div>
      </div>
    `;
  }
  function fmtSalary(min,max,cur){ const ok=v=>v!==null&&v!==undefined&&v!==''; if(!ok(min)&&!ok(max)) return '未标注'; const a=ok(min)?Number(min):null,b=ok(max)?Number(max):null; if(a!==null&&b!==null) return `${a.toLocaleString()} - ${b.toLocaleString()} ${cur||''}`; return `${(a??b).toLocaleString()} ${cur||''}`; }

  // LLM 精评（后端已屏蔽供应商名）
  async function llmMatch(jobIdEnc){
    const jobId = decodeURIComponent(jobIdEnc);
    const cv = els.cv.value.trim(); if(!cv){ toast('请先上传/粘贴简历', true); return; }

    const r = await api('/api/jobs?page=1&page_size=500'); const d = await r.json();
    const job = (d.items||[]).find(x=>x.id===jobId); if(!job){ toast('未找到该职位', true); return; }
    const jdText = [
      `Title: ${job.title}`, `Company: ${job.company}`, `Location: ${job.location||''}`,
      `Work Mode: ${job.work_mode||''}, Type: ${job.type||''}`,
      `Tags: ${(job.tags||[]).join(', ')}`, `Notes: ${job.notes||''}`
    ].join('\n');

    toast('正在精评…');
    try{
      const rr = await api('/api/match', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ jd_text: jdText, resume_text: cv })});
      const out = await rr.json();
      if(!rr.ok || out.error) throw new Error();
      alert(
        `匹配分：${out.match_score}\n\nMust 命中：${(out.must_have_hits||[]).length}；缺失：${(out.must_have_misses||[]).length}\n`+
        `Nice 命中：${(out.nice_to_have_hits||[]).length}；缺失：${(out.nice_to_have_misses||[]).length}\n\n`+
        `补差建议：\n- ${(out.gap_advice||[]).join('\n- ')}`
      );
    }catch{ toast('精评服务暂不可用', true); }
  }

  // 面试准备包
  function openInterview(jobIdEnc){
    const jobId = decodeURIComponent(jobIdEnc);
    const cv = els.cv.value.trim();
    if(cv) try{ localStorage.setItem('LGWORK_RESUME', cv); }catch{}
    window.location.href = `/public/interview.html?job_id=${encodeURIComponent(jobId)}`;
  }
</script>
</body>
</html>
