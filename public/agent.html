<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LGWORK • 求职入口</title>
<style>
  :root{--pri:#0a66c2;--bg:#f3f2ef;--fg:#091e42;--muted:#5e6c84;--card:#fff;--border:#e0e0e0}
  body{font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0}
  .wrap{max-width:1080px;margin:0 auto;padding:24px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
  .btn{background:var(--pri);color:#fff;border:0;border-radius:10px;padding:10px 16px;cursor:pointer}
  input,textarea,select{width:100%;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;font-family:inherit}
  .progress{height:6px;background:#e9eef5;border-radius:6px;overflow:hidden;margin:8px 0}
  .progress>i{display:block;height:100%;width:0;background:var(--pri);transition:width .45s ease}
  .mono{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h2>求职入口</h2>
  <div class="grid">
    <div class="card">
      <h3>上传或粘贴简历</h3>
      <input type="file" id="file" accept=".pdf,.doc,.docx,.txt" />
      <div style="margin:8px 0">或</div>
      <textarea id="resumetext" rows="8" placeholder="在此粘贴简历原文…"></textarea>
      <div class="progress"><i id="p1"></i></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <select id="lang"><option value="zh">中文</option><option value="en">English</option></select>
        <button class="btn" id="btnParse">获取画像</button>
        <button class="btn" id="btnOpt">优化简历</button>
      </div>
      <div id="profile" class="mono" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h3>为我找合适的职位</h3>
      <div class="muted">系统将先做内部筛选，然后给出最匹配的前 5–10 条。</div>
      <div class="progress"><i id="p2"></i></div>
      <button class="btn" id="btnTopK">开始匹配</button>
      <div id="topk"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>生成 ATS 简历</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <select id="lang2"><option value="zh">中文</option><option value="en">English</option></select>
      <select id="tpl"><option value="1">模板 1</option><option value="2">模板 2</option></select>
      <button class="btn" id="btnGen">生成</button>
    </div>
    <div class="progress"><i id="p3"></i></div>
    <div id="resume" class="mono" style="margin-top:10px"></div>
  </div>
</div>
<script>
const $=s=>document.querySelector(s)
function setProg(id,v){$(id).style.width=v+'%'}
function tw(el, text){ el.textContent=''; let i=0; (function t(){ el.textContent+=text.slice(i,i+2); i+=2; if(i<text.length) requestAnimationFrame(t) })() }
let PROFILE=''; let LAST_JOBDESC=''

$('#btnParse').onclick = async ()=>{
  setProg('#p1',20)
  const fd=new FormData(); const f=$('#file').files[0]; if(f) fd.append('file', f); fd.append('lang',$('#lang').value); fd.append('text',$('#resumetext').value)
  const r=await fetch('/api/resume/parse',{method:'POST',body:fd}); const d=await r.json(); setProg('#p1',80)
  PROFILE = d.profile || d.profile?.summary || d.profile || ''
  tw($('#profile'), (d.profile?.summary||d.profile||'').toString())
  setTimeout(()=>setProg('#p1',100),300)
}

$('#btnOpt').onclick = async ()=>{
  if(!PROFILE && !$('#resumetext').value){ alert('请先上传或粘贴简历'); return }
  setProg('#p1',30)
  const r=await fetch('/api/resume/optimize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text: $('#resumetext').value || PROFILE, lang: $('#lang').value})});
  const d=await r.json(); setProg('#p1',90); tw($('#profile'), d.text||''); setTimeout(()=>setProg('#p1',100),300)
}

$('#btnTopK').onclick = async ()=>{
  if(!PROFILE){ alert('请先获取画像'); return }
  setProg('#p2',25)
  const r=await fetch('/api/match/topk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({profile:PROFILE,k:8})});
  const d=await r.json(); setProg('#p2',80)
  const arr=d.items||[]
  if(!arr.length){ $('#topk').innerHTML='<div class="muted">暂无更合适的结果</div>'; setProg('#p2',100); return }
  $('#topk').innerHTML = arr.map(x=>`<div style='border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0;background:#fff'>
    <div><b>${esc(x.title)}</b> · ${esc(x.company)} <span class='muted'>${esc(x.location||'')}</span> <span style='color:#0a66c2'>${x.match?.score||''}/100</span></div>
    <div class='muted' style='margin-top:4px;font-size:13px'>${esc((x.description||'').slice(0,180))}…</div>
    <div class='mono' style='margin-top:6px'>命中要点：\n- ${(x.match?.analysis?.top_matches||[]).join('\n- ')}</div>
    <div style='margin-top:6px'><a href='${x.jd_url}' target='_blank'>申请链接 ↗</a></div>
  </div>`).join('')
  setTimeout(()=>setProg('#p2',100),300)
}

$('#btnGen').onclick = async ()=>{
  if(!PROFILE){ alert('请先获取画像'); return }
  setProg('#p3',20)
  const r=await fetch('/api/resume/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({resume_profile:PROFILE, job_desc: LAST_JOBDESC||'', lang: $('#lang2').value, template: $('#tpl').value})});
  const d=await r.json(); setProg('#p3',90); tw($('#resume'), d.text||''); setTimeout(()=>setProg('#p3',100),300)
}

function esc(s){return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;')}
</script>
</body>
</html>
