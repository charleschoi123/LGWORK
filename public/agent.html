<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LGWORK · AI 求职副驾</title>
<style>
  :root{
    --bg:#0b1220;--card:#121a2a;--muted:#94a3b8;--text:#e2e8f0;--primary:#0ea5e9;--chip:#1f2a44;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1280px;margin:0 auto;padding:24px;}
  h1{font-size:20px;margin:0 0 8px;display:flex;align-items:center;gap:8px}
  .subtitle{color:var(--muted);font-size:12px;margin-bottom:16px}
  .grid{display:grid;grid-template-columns:380px 1fr;gap:16px;align-items:start}
  .box{background:var(--card);border:1px solid #1e293b;border-radius:12px;padding:14px}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  textarea{width:100%;min-height:220px;background:#0d1525;border:1px solid #1f2a44;border-radius:10px;color:var(--text);
           padding:12px;outline:none}
  input,select{background:#0d1525;border:1px solid #1f2a44;border-radius:8px;color:var(--text);padding:10px;outline:none}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:#0e7490;border:0;border-bottom:2px solid #155e75;color:#e6faff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.secondary{background:#0b2447;border-color:#15325e}
  .btn.ghost{background:transparent;border:1px dashed #1f2a44;color:#94a3b8}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .chip{background:var(--chip);color:#cbd5e1;border:1px solid #2a3a62;padding:4px 9px;border-radius:999px;font-size:12px}
  .results{min-height:480px}
  .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .skeleton{background:#0e1729;border:1px solid #1e293b;border-radius:12px;padding:14px;margin-bottom:12px;
            animation: breathe 1.6s ease-in-out infinite}
  @keyframes breathe{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
  .card{background:#0e1729;border:1px solid #1e293b;border-radius:12px;padding:14px;margin-bottom:12px}
  .title{font-weight:600}
  .meta{color:#a3b3c8;font-size:12px;margin:6px 0 10px}
  .score{display:flex;gap:10px;font-size:12px}
  .badge{background:#0b2447;color:#a7c7ff;border:1px solid #163060;border-radius:999px;padding:3px 8px}
  .danger{color:#fca5a5}
  .ok{color:#86efac}
  .profile{background:#091222;border:1px solid #1f2a44;border-radius:10px;padding:10px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>LGWORK · AI 求职副驾</h1>
  <div class="subtitle">上传/粘贴简历 → 一键分析并推荐（画像摘要 + 关键词）→ 自动开始职位精评（可选）</div>

  <div class="grid">
    <!-- 左侧 -->
    <div class="box">
      <div class="label">简历文本</div>
      <textarea id="resume" placeholder="粘贴简历或点击下方上传（支持 PDF/DOCX/TXT）"></textarea>
      <div class="row" style="margin-top:8px">
        <input type="file" id="file" />
        <button class="btn secondary" id="btnUpload">上传并解析</button>
      </div>

      <div class="label" style="margin-top:12px">关键词（可留空，系统会从简历中自动提取）</div>
      <input id="kw" style="width:100%" placeholder="如：ADC, 抗体, 临床运营, Python, NLP">

      <div class="row" style="margin-top:8px">
        <input id="loc" placeholder="地点偏好（可留空，如：上海）" style="flex:1">
        <select id="type">
          <option value="">类型</option><option value="full">全职</option><option value="part">兼职</option><option value="project">项目制</option>
        </select>
        <select id="mode">
          <option value="">工作制</option><option value="onsite">到岗</option><option value="hybrid">混合</option><option value="remote">远程</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px;justify-content:space-between">
        <label class="row" style="gap:6px;font-size:13px;color:#cbd5e1">
          <input type="checkbox" id="use_llm"> 使用 LLM 精评（需已配置 DeepSeek Key）
        </label>
        <div class="row">
          <button class="btn ghost" id="btnClear">清空</button>
          <button class="btn" id="btnGo">分析并推荐</button>
        </div>
      </div>

      <div id="profile" class="profile" style="display:none"></div>
    </div>

    <!-- 右侧：结果 -->
    <div class="box">
      <div class="toolbar">
        <div class="label">共 <b id="count">0</b> 条推荐（按粗配分/LLM 分排序）</div>
        <select id="pageSize">
          <option value="20">显示 20</option>
          <option value="50">显示 50</option>
          <option value="100">显示 100</option>
        </select>
      </div>
      <div id="results" class="results"></div>
    </div>
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const resume = $("#resume");
const btnUpload = $("#btnUpload");
const file = $("#file");
const btnGo = $("#btnGo");
const btnClear = $("#btnClear");
const results = $("#results");
const countEl = $("#count");
const kw = $("#kw"), loc = $("#loc"), type = $("#type"), mode = $("#mode");
const useLLM = $("#use_llm");
const pageSize = $("#pageSize");
const profileBox = $("#profile");

function toast(msg){
  console.log(msg);
}

function skeleton(n=6){
  results.innerHTML="";
  for(let i=0;i<n;i++){
    const d=document.createElement("div");
    d.className="skeleton";
    d.innerHTML=`<div class="title">加载中…</div><div class="meta">正在生成推荐与画像</div>`;
    results.appendChild(d);
  }
}

function chip(text){
  const s=document.createElement("span");
  s.className="chip";
  s.textContent=text;
  return s;
}

async function api(path, data){
  const r = await fetch(path, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data||{})
  });
  return r.json();
}

btnUpload.onclick = async ()=>{
  if(!file.files.length){ toast("请选择文件"); return;}
  const fd=new FormData(); fd.append("file", file.files[0]);
  const r = await fetch("/api/upload_resume",{method:"POST", body:fd});
  const data = await r.json();
  if(data.ok){ resume.value = data.text || ""; toast("解析完成"); }
  else{ toast("解析失败"); }
};

btnClear.onclick = ()=>{
  resume.value=""; kw.value=""; loc.value=""; type.value=""; mode.value="";
  results.innerHTML=""; countEl.textContent="0"; profileBox.style.display="none";
};

btnGo.onclick = async ()=>{
  const text = resume.value.trim();
  if(!text){ toast("请先粘贴或上传简历"); return; }

  // 先画像
  profileBox.style.display="none";
  let profile = null;
  try{
    const prof = await api("/api/profile", {resume_text:text});
    if(prof.ok){
      profile = prof.profile || {};
      const kws = (profile.keywords||[]).slice(0,12);
      profileBox.innerHTML = `
        <div style="color:#a3b3c8;font-size:12px;margin-bottom:6px">画像摘要</div>
        <div style="white-space:pre-wrap">${(profile.summary||"").slice(0,400)}</div>
        <div class="chips" id="profKw"></div>`;
      profileBox.style.display="block";
      const kbox = $("#profKw");
      kws.forEach(k=>kbox.appendChild(chip(k)));
      if(!kw.value && kws.length){ kw.value = kws.slice(0,8).join(", "); }
    }
  }catch(e){ /* 忽略 */ }

  // 再推荐
  skeleton(6);
  const payload = {
    resume_text: text,
    keywords: kw.value,
    location: loc.value,
    type: type.value,
    work_mode: mode.value,
    use_llm: useLLM.checked,
    topn: 10
  };
  const data = await api("/api/analyze_recommend", payload);
  const items = (data.items||[]).slice(0, parseInt(pageSize.value||"20",10));
  countEl.textContent = items.length.toString();
  results.innerHTML="";

  // 逐条插入（让等待不无聊）
  for(let i=0;i<items.length;i++){
    addCard(items[i]);
    await new Promise(r=>setTimeout(r, 120)); // 轻微延迟
  }
};

function addCard(j){
  const c=document.createElement("div");
  c.className="card";
  const tags = (j.tags||[]).slice(0,6).map(t=>`<span class="chip">${t}</span>`).join(" ");
  const rscore = j.rough_score ?? 0;
  const lscore = (j.llm_score!=null) ? j.llm_score : null;
  const color = lscore!=null ? (lscore>=85?"ok":"") : (rscore>=8?"ok":"");
  const llmPart = (lscore!=null) ? `<span class="badge">LLM 分：<b class="${color}">${lscore}</b></span>` : `<span class="badge">LLM 分：评估中</span>`;

  c.innerHTML = `
    <div class="title">${escapeHtml(j.title||"未命名职位")}</div>
    <div class="meta">${escapeHtml(j.company||"")} · ${escapeHtml(j.location||"")} · <a href="${j.jd_url||'#'}" target="_blank">原链</a></div>
    <div class="score">
      <span class="badge">粗配分：<b>${rscore}</b></span>
      ${llmPart}
    </div>
    <div class="chips" style="margin-top:8px">${tags}</div>
  `;
  results.appendChild(c);
}

function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
</script>
</body>
</html>
