<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>LGWORK · JD/简历匹配评估</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --panel:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#38bdf8; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; }
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(11,15,20,.85);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0 0 8px;font-size:20px;display:flex;gap:10px;align-items:center}.dot{width:10px;height:10px;border-radius:999px;background:var(--brand);box-shadow:0 0 14px var(--brand)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px} @media(max-width:980px){.grid{grid-template-columns:1fr}}
    textarea{width:100%;min-height:260px;padding:12px;border-radius:12px;border:1px solid #29303a;background:var(--panel);color:var(--text);resize:vertical}
    .panel{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    input,select,button{padding:10px 12px;border-radius:12px;border:1px solid #29303a;background:var(--panel);color:var(--text)}
    button{cursor:pointer}
    .primary{background:#0369a1;border-color:#0369a1}
    .success{color:var(--ok)} .warn{color:var(--warn)} .err{color:#fecaca}
    .kpi{display:flex;gap:14px;flex-wrap:wrap}
    .kpi .box{background:var(--panel);border:1px solid #29303a;border-radius:12px;padding:10px 12px;min-width:120px}
    ul{margin:6px 0 0 18px}
    .toast{position:fixed;bottom:14px;right:14px;background:var(--panel);border:1px solid #29303a;padding:10px 12px;border-radius:12px;display:none}
    a.link{color:#93c5fd;text-decoration:none}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1><span class="dot"></span>LGWORK · JD/简历匹配评估</h1>
    <div class="small">贴上 JD 与简历文本，点击“评估匹配”。支持 DeepSeek（后端调用），不会在前端暴露密钥。</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <div class="panel">
      <div>JD 文本</div>
      <textarea id="jd" placeholder="在此粘贴职位描述（含 must-have / nice-to-have 优先）"></textarea>
    </div>
    <div class="panel">
      <div>简历文本</div>
      <textarea id="cv" placeholder="在此粘贴候选人简历文本（或关键经历梳理）"></textarea>
    </div>
  </div>

  <div class="panel" style="margin-top:14px">
    <div class="row">
      <button id="btnEval" class="primary">评估匹配</button>
      <button id="btnClear">清空</button>
      <span class="small">可选：输入 job_id 后可将评估的职位加入“跟进”。</span>
    </div>
    <div class="row">
      <input id="jobId" placeholder="job_id（可从 /api/jobs 返回的 id 复制）" style="min-width:320px" />
      <button id="btnTrack">加入跟进</button>
    </div>
  </div>

  <div id="result" class="panel" style="margin-top:14px; display:none">
    <div class="kpi">
      <div class="box">匹配分：<span id="score" class="success">-</span></div>
      <div class="box">Must-have 命中：<span id="mhit">-</span></div>
      <div class="box">Must-have 缺失：<span id="mmiss">-</span></div>
      <div class="box">Nice-to-have 命中：<span id="nhit">-</span></div>
      <div class="box">Nice-to-have 缺失：<span id="nmiss">-</span></div>
    </div>

    <div style="margin-top:10px">
      <h3 style="margin:10px 0 6px">补差建议</h3>
      <ul id="advice"></ul>
    </div>

    <div style="margin-top:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:10px 0 6px">定制简历要点（可复制到简历）</h3>
        <button id="btnCopy">复制要点</button>
      </div>
      <ul id="bullets"></ul>
    </div>

    <div style="margin-top:10px">
      <details>
        <summary>展开查看命中/缺失明细</summary>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">
          <div class="panel">
            <div><strong>Must-have 命中</strong></div>
            <ul id="mhits"></ul>
          </div>
          <div class="panel">
            <div><strong>Must-have 缺失</strong></div>
            <ul id="mmisses"></ul>
          </div>
          <div class="panel">
            <div><strong>Nice-to-have 命中</strong></div>
            <ul id="nhits"></ul>
          </div>
          <div class="panel">
            <div><strong>Nice-to-have 缺失</strong></div>
            <ul id="nmisses"></ul>
          </div>
        </div>
      </details>
    </div>
  </div>
</main>

<div id="toast" class="toast"></div>

<script>
  // -------------------------
  // 这里改成你的后端 API 地址
  // 本地:  http://127.0.0.1:8080
  // Render: https://你的服务名.onrender.com
  // 同域部署(访问 /public/match.html) 可设为 '' 空字符串
  const API_BASE = '';
  // -------------------------

  const els = {
    jd: document.getElementById('jd'),
    cv: document.getElementById('cv'),
    btnEval: document.getElementById('btnEval'),
    btnClear: document.getElementById('btnClear'),
    btnTrack: document.getElementById('btnTrack'),
    jobId: document.getElementById('jobId'),
    result: document.getElementById('result'),
    score: document.getElementById('score'),
    mhit: document.getElementById('mhit'),
    mmiss: document.getElementById('mmiss'),
    nhit: document.getElementById('nhit'),
    nmiss: document.getElementById('nmiss'),
    advice: document.getElementById('advice'),
    bullets: document.getElementById('bullets'),
    mhits: document.getElementById('mhits'),
    mmisses: document.getElementById('mmisses'),
    nhits: document.getElementById('nhits'),
    nmisses: document.getElementById('nmisses'),
    btnCopy: document.getElementById('btnCopy'),
    toast: document.getElementById('toast'),
  };

  function api(url, opts={}) {
    const base = API_BASE && API_BASE !== 'REPLACE_ME' ? API_BASE : '';
    return fetch(base + url, Object.assign({
      headers: { 'Content-Type': 'application/json' }
    }, opts));
  }

  function toast(msg, isErr=false) {
    els.toast.textContent = msg;
    els.toast.style.display = 'block';
    els.toast.style.borderColor = isErr ? '#7f1d1d' : '#29303a';
    setTimeout(()=>{ els.toast.style.display = 'none'; }, 2000);
  }

  function li(s){ return `<li>${escapeHtml(s)}</li>`; }
  function escapeHtml(s){ return (s || '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

  async function evaluate() {
    const jd = els.jd.value.trim();
    const cv = els.cv.value.trim();
    if (!jd || !cv) { toast('请先粘贴 JD 和简历文本', true); return; }

    els.result.style.display = 'none';
    toast('正在评估…');

    try {
      const r = await api('/api/match', { method:'POST', body: JSON.stringify({ jd_text: jd, resume_text: cv }) });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || ('HTTP ' + r.status));

      // 渲染
      els.result.style.display = 'block';
      els.score.textContent = data.match_score ?? '-';
      els.mhit.textContent = (data.must_have_hits || []).length;
      els.mmiss.textContent = (data.must_have_misses || []).length;
      els.nhit.textContent = (data.nice_to_have_hits || []).length;
      els.nmiss.textContent = (data.nice_to_have_misses || []).length;

      const as = (data.gap_advice || []).map(li).join('') || '<li>—</li>';
      const bs = (data.resume_bullets || []).map(li).join('') || '<li>—</li>';
      els.advice.innerHTML = as;
      els.bullets.innerHTML = bs;

      els.mhits.innerHTML = (data.must_have_hits || []).map(li).join('') || '<li>—</li>';
      els.mmisses.innerHTML = (data.must_have_misses || []).map(li).join('') || '<li>—</li>';
      els.nhits.innerHTML = (data.nice_to_have_hits || []).map(li).join('') || '<li>—</li>';
      els.nmisses.innerHTML = (data.nice_to_have_misses || []).map(li).join('') || '<li>—</li>';

      toast('评估完成');
    } catch (e) {
      console.error(e);
      toast('评估失败：' + e.message, true);
    }
  }

  async function track() {
    const job_id = els.jobId.value.trim();
    if (!job_id) { toast('请填写 job_id', true); return; }
    try {
      const r = await api('/api/track', { method:'POST', body: JSON.stringify({ job_id, status:'准备中', notes:'' }) });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || ('HTTP ' + r.status));
      toast('已加入“跟进”');
    } catch (e) {
      console.error(e);
      toast('加入失败：' + e.message, true);
    }
  }

  async function copyBullets() {
    const lis = els.bullets.querySelectorAll('li');
    const lines = Array.from(lis).map(li => '- ' + li.textContent.trim()).join('\n');
    if (!lines) { toast('没有可复制的要点', true); return; }
    try {
      await navigator.clipboard.writeText(lines);
      toast('已复制到剪贴板');
    } catch {
      toast('复制失败', true);
    }
  }

  // 事件
  els.btnEval.onclick = evaluate;
  els.btnClear.onclick = () => { els.jd.value=''; els.cv.value=''; els.result.style.display='none'; };
  els.btnTrack.onclick = track;
  els.btnCopy.onclick = copyBullets;

</script>
</body>
</html>
